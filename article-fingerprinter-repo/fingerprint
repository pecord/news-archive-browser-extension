#!/usr/bin/env python3
"""
Article Fingerprinter CLI

Command-line interface for article fingerprinting with report generation.

Usage:
    fingerprint <url> [--output html|markdown|json]
"""

import sys
import json
from datetime import datetime
from urllib.parse import urlparse
import requests

from article_fingerprinter import ArticleFingerprinter, ReportGenerator


def main():
    """CLI interface"""
    if len(sys.argv) < 2:
        print("Usage: fingerprint <url> [--output html|markdown|json]")
        sys.exit(1)
    
    url = sys.argv[1]
    output_format = 'html'
    
    if len(sys.argv) >= 4 and sys.argv[2] == '--output':
        output_format = sys.argv[3]
    
    print(f"Fetching article from: {url}")
    
    # Fetch HTML
    try:
        response = requests.get(url, headers={'User-Agent': 'Mozilla/5.0'}, timeout=15)
        response.raise_for_status()
        html = response.text
    except Exception as e:
        print(f"Error fetching URL: {e}")
        sys.exit(1)
    
    print("Processing article...")
    
    # Fingerprint
    fingerprinter = ArticleFingerprinter()
    results = fingerprinter.fingerprint(html, url)
    
    # Generate report
    reporter = ReportGenerator()
    
    if output_format == 'json':
        # Remove full text from JSON (too large)
        results_copy = results.copy()
        results_copy['supermajority_extraction'] = {
            'word_count': results['supermajority_extraction']['word_count'],
            'hash': results['supermajority_extraction']['hash'],
        }
        print(json.dumps(results_copy, indent=2))
        
    elif output_format == 'markdown':
        report = reporter.generate_markdown(results)
        
        # Save to file
        domain = urlparse(url).netloc.replace('www.', '')
        filename = f"article_report_{domain}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        with open(filename, 'w', encoding='utf-8') as f:
            f.write(report)
        print(f"\n✓ Report saved to: {filename}")
        
    else:  # html
        report = reporter.generate_html(results)
        
        # Save to file
        domain = urlparse(url).netloc.replace('www.', '')
        filename = f"article_report_{domain}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.html"
        with open(filename, 'w', encoding='utf-8') as f:
            f.write(report)
        print(f"\n✓ Report saved to: {filename}")


if __name__ == '__main__':
    main()
